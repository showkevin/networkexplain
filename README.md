# 網路運作原理簡介

# 網段特色

## 相同網段 (OSI Model Level 2 : Data Link)
- 封包碰撞，同網段間主機越多，則越容易封包碰撞，網路效能會變差。
- 主機間若用 Hub 連接，則每個主機都可以接收到同網段其他主機的封包。若目的地 mac address 為自己時則複製下來，否則拋棄。 (OSI Model Level 2)
- 若主機間用 Switch 連接，則只會收到給自己 mac address 的封包，與會收到廣播封包。Switch 會自己學習對應不同主機的 mac address 要傳給哪個 port。
- 廣播封包
    - ARP (Address Resolution Protocal) Request
        - 發送封包時需要填寫 ip 與 mac address，若只知道 ip 卻不知道 mac address 時，可以發送廣播封包問大家請問 xxx ip 的 mac address 是多少？若被詢問的 ip 主機發現是再問自己，就會廣播回應說我的 mac address 是多少。
    - DHCP
        - 若主機第一次上網，尚未有任何 ip 設定時可以跟 DHCP 主機要求提供 ip address，同時取得其他必要資訊 (Netmask、DNS address、Default Gateway...)

## 不同網段 (OSI Model Level 3 : Network)
- 假設有 A & B 兩個網段，主機間的封包傳送會透過路由器轉送，從 A 網段到 A 網段的 Default Gateway ，透過路由器轉送到 B 網段的 Default Gateway，再轉送到 B 網段。
- 廣播封包無法透過路由器轉送 
    

# 資料傳送

- 用 ip 與 subnet mask (子網路遮罩) 做 AND 判斷。 (Level 3 網路層)
    - 若同網段則開始填寫 mac address (Level 2 資料鏈接層)
        1. 查 ARP Cache
            - 查到則填寫目標主機 mac address
            - 查不到則發 ARP Request
        2. 填寫好 mac address 即可發送至實體層實際傳輸資料
    - 若不同網段 (傳送到 default gateway 由 router 轉發到其他網段)
        1. 查找 default gateway mac address 並傳送
        2. 路由器自行判斷至哪個網段並轉發至該網段的 default gateway
        3. 查找該網段主機的 mac address 並轉發

# 網段切割

## ip
- ip 位址包含 32 位元的資訊，可切分為 4 段
    - 十進位 : 192.168.0.2
    - 二進位 : 1100 0000 . 1010 1000 . 0000 0000 . 0000 0010

## 網路與主機
- A 級 : 網路 主機 主機 主機  (1111 1111 . 0000 0000 . 0000 0000 . 0000 0000)
- B 級 : 網路 網路 主機 主機  (1111 1111 . 1111 1111 . 0000 0000 . 0000 0000)
- C 級 : 網路 網路 網路 主機  (1111 1111 . 1111 1111 . 1111 1111 . 0000 0000)

- A 級 :　可用主機　2^24 -2 = 16,777,214 個主機可用 (ip 可分配)
- B 級 :　可用主機　2^16 -2 = 65,534 個主機可用 (ip 可分配)
- C 級 :　可用主機　2^8 -2 = 254 個主機可用 (ip 可分配) 

## 私有 IP (保留)

> 公司(家用)內部網段

- A 級 :　10.0.0.0 ~ 10.255.255.255
- B 級 :　172.16.0.0 ~ 172.31.255.255
- C 級 :　192.168.0.0 ~ 192.168.255.255


# 子網路切割
## 原由
- A B C　級分類不符合需求，用 A 或 B 或 C 級根據公司或部門切割，很多時候主機數量太多，浪費沒用到的 ip。
- 例如: 行銷部門只有 10 個人，給一個 C 級的網段如 192.168.10.X 的網段，如上面知該行銷部門實際可分配的 ip 數量有 254 個，但該部門只有 10 人，剩下的 244 個 ip 浪費掉。

## 解決方式 :　無級別的跨網域繞送 (Classless Inter-Domain Routing) CIDR

- 透過子網路遮罩 (subnet mask) 切割網段

### Subnet mask
- 預設子網路遮罩
    - A 級 : 255.0.0.0  
        - (1111 1111 . 0000 0000 . 0000 0000 . 0000 0000)
        - /8
    - B 級 : 255.255.0.0
        - (1111 1111 . 1111 1111 . 0000 0000 . 0000 0000)
        - /16
    - C 級 : 255.255.255.0
        - (1111 1111 . 1111 1111 . 1111 1111 . 0000 0000)
        - /24

### 判斷是否為同一網段 : AND 運算
範例一
- subnet mask : 255.255.255.0  (1111 1111 . 1111 1111 . 1111 1111 . 0000 0000) /24
- A ip : 192.168.100.16 (1100 0000 . 1010 1000 . 0110 0100 . 0001 0000)
- B ip : 192.168.100.24 (1100 0000 . 1010 1000 . 0110 0100 . 0001 1000)
1. A 與 subnet mask AND 運算結果 : 192.168.100.0 (1100 0000 . 1010 1000 . 0110 0100 . 0000 0000)
2. B 與 subnet mask AND 運算結果 : 192.168.100.0 (1100 0000 . 1010 1000 . 0110 0100 . 0000 0000)
3. 因 1 與 2 的運算結果相同，所以為同一網段

範例二
- subnet mask : 255.255.255.248  (1111 1111 . 1111 1111 . 1111 1111 . 1111 1000) /28
- A ip : 192.168.100.16 (1100 0000 . 1010 1000 . 0110 0100 . 0001 0000)
- B ip : 192.168.100.24 (1100 0000 . 1010 1000 . 0110 0100 . 0001 1000)
1. A 與 subnet mask AND 運算結果 : 192.168.100.16 (1100 0000 . 1010 1000 . 0110 0100 . 0001 0000)
2. B 與 subnet mask AND 運算結果 : 192.168.100.24 (1100 0000 . 1010 1000 . 0110 0100 . 0001 1000)
3. 因 1 與 2 的運算結果不同，所以為不同網段

### 規劃與切割

- 所選子網路遮罩可產生幾組子網路?
- 每個子網路有多少個可用主機?
- 有效的子網路為何?
- 每組子網路的廣播位址為何？
- 每個子網路的有效主機為何？

### 範例一

```
example: 

IPv4 位址 ..... 192.168.10.0
子網路遮罩 .... 255.255.255.128
```
```
- 所選子網路遮罩可產生幾組子網路?
255.255.255.128
1111 1111 . 1111 1111 . 1111 1111 . 1000 0000

因為 128 (1000 0000) 

所以 2^1 = 2 (組)
```
```
- 每個子網路有多少個可用主機?

有 7 個主機位元 (1000 0000)

所以 2^7 -2 = 126 (部主機)
```
```
- 有效的子網路為何?

256 - 128 = 128
由 0 開始所以

0 ~ 127
128 ~ 256
```
```
- 每組子網路的廣播位址為何？

第一組
1100 0000 . 1010 1000 . 0000 1010 . 0111 1111
192.168.10.127

第二組
1100 0000 . 1010 1000 . 0000 1010 . 1111 1111
192.168.10.255
```
```
- 每個子網路的有效主機為何？
```
| 子網路    | 0   | 128 |
| ------ | --- | --- |
| 第一部主機  | 1   | 129 |
| 最後一部主機 | 126 | 254 |
| 廣播位址   | 127 | 255 |

### 範例二

```
example: 

IPv4 位址 ..... 192.168.10.0
子網路遮罩 .... 255.255.255.192
```
```
- 所選子網路遮罩可產生幾組子網路?
255.255.255.192
1111 1111 . 1111 1111 . 1111 1111 . 1100 0000

因為 192 (1100 0000) 

所以 2^2 = 4 (組)
```
```
- 每個子網路有多少個可用主機?

有 7 個主機位元 (1000 0000)

所以 2^6 -2 = 62 (部主機)
```
```
- 有效的子網路為何?

256 - 192 = 64
由 0 開始所以

0 ~ 63 (0000 0000 ~ 0011 1111)
64 ~ 127 (0100 0000 ~ 0111 1111)
128 ~ 191 (1000 0000 ~ 1011 1111)
192 ~ 255 (1100 0000 ~ 1111 1111)
```
```
- 每組子網路的廣播位址為何？

第一組
1100 0000 . 1010 1000 . 0000 1010 . 0011 1111
192.168.10.63

第二組
1100 0000 . 1010 1000 . 0000 1010 . 0111 1111
192.168.10.127

第二組
1100 0000 . 1010 1000 . 0000 1010 . 1011 1111
192.168.10.191

第二組
1100 0000 . 1010 1000 . 0000 1010 . 1111 1111
192.168.10.255
```
```
- 每個子網路的有效主機為何？
```
| 子網路    | 0  | 64  | 128 | 192 |
| ------ | -- | --- | --- | --- |
| 第一部主機  | 1  | 65  | 129 | 193 |
| 最後一部主機 | 62 | 126 | 190 | 254 |
| 廣播位址   | 63 | 127 | 191 | 255 |
